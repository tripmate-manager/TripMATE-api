<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.tripmate.domain.dailyplans.dao.mapper.DailyPlanDAOMapper">
    <insert id="insertDailyPlan" parameterType="DailyPlanDTO">
        <selectKey keyProperty="dailyPlanNo" keyColumn="DAILYPLAN_NO" resultType="String" order="AFTER">
            SELECT LAST_INSERT_ID()
        </selectKey>
        INSERT INTO CT_DAILYPLAN (PLAN_NO,
                                  POST_NO,
                                  DAY_GRP,
                                  DAILYPLAN_DTIME,
                                  REG_NO,
                                  REG_DTIME,
                                  UPT_NO,
                                  UPT_DTIME)
        VALUES (#{planNo:VARCHAR}
                ,#{postNo:VARCHAR}
                ,#{dayGroupNo:VARCHAR}
                ,STR_TO_DATE(#{dailyPlanDateTime:VARCHAR}, '%Y%m%d%H%i%s')
                ,#{memberNo:VARCHAR}
                ,now()
                ,#{memberNo:VARCHAR}
                ,now());
    </insert>

    <update id="updatePostMappingYnWithPostNo" parameterType="DailyPlanDTO">
        UPDATE CT_POST_MGMT
        SET MPPG_YN = 'Y',
            UPT_NO = #{memberNo:VARCHAR},
            UPT_DTIME = now()
        WHERE POST_NO = #{postNo:VARCHAR};
    </update>

    <delete id="deleteDailyPlan" parameterType="String">
        DELETE FROM CT_DAILYPLAN
        WHERE DAILYPLAN_NO = #{dailyPlanNo:VARCHAR};
    </delete>

    <select id="getDailyPlanCntWithDailyPlanNo" parameterType="String" resultType="int">
        SELECT COUNT(1)
        FROM CT_DAILYPLAN
        WHERE POST_NO = (SELECT POST_NO FROM CT_DAILYPLAN WHERE DAILYPLAN_NO = #{dailyPlanNo:VARCHAR});
    </select>

    <update id="updatePostMappingYnWithDailyPlanNo" parameterType="DeleteDailyPlanDTO">
        UPDATE CT_POST_MGMT cpm
        INNER JOIN CT_DAILYPLAN cd
        ON cpm.POST_NO  = cd.POST_NO
        SET cpm.MPPG_YN = 'N',
            cpm.UPT_NO = #{memberNo:VARCHAR},
            cpm.UPT_DTIME = now()
        WHERE cd.DAILYPLAN_NO = #{dailyPlanNo:VARCHAR};
    </update>

    <select id="searchDailyPlanCntByDay" parameterType="String" resultType="DailyPlanCntVO">
        SELECT DAY_GRP AS dayGroup
             ,COUNT(1) AS dailyPlanCnt
        FROM CT_DAILYPLAN
        WHERE PLAN_NO = #{planNo:VARCHAR}
        GROUP BY DAY_GRP;
    </select>

    <resultMap id="searchDailyPlanListByDay" type="DailyPlanVO">
        <result property="memberNo" column="MBR_NO"/>
        <result property="planNo" column="PLAN_NO"/>
        <result property="dayGroup" column="DAY_GRP"/>
        <result property="achieveRate" column="ACHV_RATE"/>
        <collection property="dailyPlanItemList" column="{memberNo=MBR_NO,planNo=PLAN_NO,dayGroup=DAY_GRP}" javaType="List" ofType="DailyPlanItemVO" select="getDailyPlanItemList"/>
    </resultMap>

    <select id="searchDailyPlanListByDay" parameterType="DailyPlanByDayDTO" resultMap="searchDailyPlanListByDay">
        SELECT #{memberNo:VARCHAR} AS MBR_NO
             ,cd.PLAN_NO
             ,cd.DAY_GRP
             ,TRUNCATE((SELECT COUNT(1) FROM CT_DAILYPLAN WHERE PLAN_NO = #{planNo:VARCHAR} AND DAY_GRP = #{dayGroup:VARCHAR} AND REV_AVG_SCORE IS NOT NULL) / COUNT(1) * 100, 0) AS ACHV_RATE
        FROM CT_DAILYPLAN cd
        WHERE cd.PLAN_NO = #{planNo:VARCHAR}
          AND cd.DAY_GRP = #{dayGroup:VARCHAR};
    </select>

    <resultMap id="getDailyPlanItemList" type="DailyPlanItemVO">
        <result property="dailyPlanNo" column="DAILYPLAN_NO"/>
        <result property="postNo" column="POST_NO"/>
        <result property="dailyPlanDateTime" column="DAILYPLAN_DTIME"/>
        <result property="notificationYn" column="NOTI_YN"/>
        <result property="reviewAverageScore" column="REV_AVG_SCORE"/>
        <result property="postTypeCode" column="POST_TP_CD"/>
        <result property="postTitle" column="POST_TITLE"/>
        <result property="postContents" column="POST_CONTS"/>
        <result property="spotAddress" column="SPOT_ADDR"/>
        <result property="registrationNo" column="REG_NO"/>
    </resultMap>

    <select id="getDailyPlanItemList" parameterType="DailyPlanByDayDTO" resultMap="getDailyPlanItemList">
        SELECT cd.DAILYPLAN_NO
             ,cd.POST_NO
             ,cd.DAILYPLAN_DTIME
             ,(SELECT IF((SELECT COUNT(1) FROM CT_NOTI_MGMT WHERE DAILYPLAN_NO = cd.DAILYPLAN_NO AND RCVER_NO = #{memberNo:VARCHAR}) > 0, 'Y', 'N')) AS NOTI_YN
             ,ROUND(cd.REV_AVG_SCORE, 1) AS REV_AVG_SCORE
             ,cpm.POST_TP_CD
             ,cpm.POST_TITLE
             ,cpm.POST_CONTS
             ,cpm.SPOT_ADDR
             ,cpm.REG_NO
        FROM CT_DAILYPLAN cd, CT_POST_MGMT cpm
        WHERE cd.POST_NO = cpm.POST_NO
          AND cd.PLAN_NO = #{planNo:VARCHAR}
          AND cd.DAY_GRP = #{dayGroup:VARCHAR}
        ORDER BY cd.DAILYPLAN_DTIME;
    </select>

    <delete id="deleteDailyPlanNotification" parameterType="DeleteDailyPlanNotificationDTO">
        DELETE FROM CT_NOTI_MGMT
        WHERE NOTI_TP_CD = '10'
          AND DAILYPLAN_NO = #{dailyPlanNo:VARCHAR}
          AND SENDER_NO = #{memberNo:VARCHAR};
    </delete>

    <update id="updateDailyPlanNotification" parameterType="NotificationDTO">
        UPDATE CT_NOTI_MGMT
        SET NOTI_DTIME = STR_TO_DATE(#{notificationDateTime:VARCHAR}, '%Y%m%d%H%i%s'),
            UPT_NO = #{senderNo:VARCHAR},
            UPT_DTIME = now()
        WHERE NOTI_TP_CD = #{notificationTypeCode:VARCHAR}
          AND DAILYPLAN_NO = #{dailyPlanNo:VARCHAR}
          AND SENDER_NO = #{senderNo:VARCHAR};
    </update>
</mapper>